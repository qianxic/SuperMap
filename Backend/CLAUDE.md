# SuperMap GIS + AI åç«¯æ¶æ„è®°å¿†æ–‡ä»¶

## ğŸ¯ é¡¹ç›®æ¦‚è¿°
åŸºäº FastAPI + LangChain çš„å¤šæ™ºèƒ½ä½“ GIS ç³»ç»Ÿï¼Œé‡‡ç”¨é¢†åŸŸé©±åŠ¨è®¾è®¡(DDD)å’Œæ¸…æ´æ¶æ„ï¼Œé›†æˆ SuperMapã€çŸ¥è¯†åº“å’Œå¤šæ™ºèƒ½ä½“åä½œèƒ½åŠ›ã€‚

**å½“å‰çŠ¶æ€**: å·²å®Œæˆå®Œæ•´ç›®å½•æ¶æ„æ­å»º (94ä¸ªæ–‡ä»¶)ï¼Œå‡†å¤‡å¼€å§‹åˆ†é˜¶æ®µå®ç°ã€‚

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„è®¾è®¡

### æ¶æ„å±‚æ¬¡ (è‡ªå†…å‘å¤–)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API Layer (FastAPI)         - æ¥å£å±‚                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Infrastructure Layer        - åŸºç¡€è®¾æ–½å±‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Application Layer           - åº”ç”¨å±‚                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Domain Layer (DDD)          - é¢†åŸŸå±‚                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Core Layer                  - æ ¸å¿ƒå±‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç›®å½•ç»“æ„æ ¸å¿ƒæ¨¡å—
- `app/core/` - åŸºç¡€è®¾æ–½é…ç½® (æ•°æ®åº“ã€ç¼“å­˜ã€å®‰å…¨)
- `app/domains/` - é¢†åŸŸå±‚ (agent, gis, knowledge, user)
- `app/application/` - åº”ç”¨å±‚ (ç”¨ä¾‹ã€DTOã€äº‹ä»¶å¤„ç†)
- `app/infrastructure/` - åŸºç¡€è®¾æ–½å®ç° (AIã€æ•°æ®åº“ã€å¤–éƒ¨æœåŠ¡)
- `app/api/` - API æ¥å£å±‚

## ğŸ’¾ æ•°æ®åº“è®¾è®¡

### æ•°æ®å­˜å‚¨æ¶æ„ (ä¼˜åŒ–å 3 å±‚å­˜å‚¨)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸»åº“: PostgreSQL + PostGIS                         â”‚
â”‚ â”œâ”€â”€ users (ç”¨æˆ·æ•°æ®)                                 â”‚
â”‚ â”œâ”€â”€ gis_data (ç©ºé—´æ•°æ®ã€å‡ ä½•å¯¹è±¡)                     â”‚
â”‚ â”œâ”€â”€ chat_sessions (å¯¹è¯è®°å½•)                         â”‚
â”‚ â”œâ”€â”€ knowledge_docs (çŸ¥è¯†åº“æ–‡æ¡£å…ƒæ•°æ®)                â”‚
â”‚ â””â”€â”€ agent_workflows (æ™ºèƒ½ä½“å·¥ä½œæµ)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¼“å­˜å±‚: Redis Cluster                              â”‚
â”‚ â”œâ”€â”€ session:* (ç”¨æˆ·ä¼šè¯)                            â”‚
â”‚ â”œâ”€â”€ cache:query:* (æŸ¥è¯¢ç¼“å­˜)                        â”‚
â”‚ â”œâ”€â”€ agent:status:* (æ™ºèƒ½ä½“çŠ¶æ€)                     â”‚
â”‚ â””â”€â”€ task:queue:* (ä»»åŠ¡é˜Ÿåˆ—)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å‘é‡å­˜å‚¨: Qdrant/Weaviate                          â”‚
â”‚ â”œâ”€â”€ knowledge_vectors (æ–‡æ¡£å‘é‡)                     â”‚
â”‚ â”œâ”€â”€ gis_vectors (ç©ºé—´ç‰¹å¾å‘é‡)                       â”‚
â”‚ â””â”€â”€ chat_vectors (å¯¹è¯ä¸Šä¸‹æ–‡å‘é‡)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ•°æ®æ¨¡å‹
- **ç©ºé—´æ•°æ®**: PostGIS geometry/geography ç±»å‹
- **å‘é‡æ•°æ®**: 1536ç»´ embedding (OpenAI ada-002)
- **ä¼šè¯æ•°æ®**: JSON æ ¼å¼å­˜å‚¨å¯¹è¯ä¸Šä¸‹æ–‡
- **å·¥ä½œæµæ•°æ®**: æ™ºèƒ½ä½“æ‰§è¡ŒçŠ¶æ€å’Œç»“æœ

## ğŸ¤– å¤šæ™ºèƒ½ä½“æ¶æ„ (ä¼˜åŒ–ç‰ˆ)

### 3å±‚æ™ºèƒ½ä½“è®¾è®¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Agent Hub ä¸­å¿ƒ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Coordinator     â†’    Executor      â†’   Aggregator   â”‚
â”‚  åè°ƒæ™ºèƒ½ä½“           æ‰§è¡Œæ™ºèƒ½ä½“         èšåˆæ™ºèƒ½ä½“    â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€æ„å›¾ç†è§£â”€â”        â”Œâ”€å·¥å…·è°ƒåº¦â”€â”       â”Œâ”€ç»“æœèšåˆâ”€â”    â”‚
â”‚  â”‚çŸ¥è¯†æ£€ç´¢  â”‚        â”‚å¹¶è¡Œæ‰§è¡Œ  â”‚       â”‚æ ¼å¼åŒ–   â”‚    â”‚
â”‚  â”‚ä»»åŠ¡è§„åˆ’  â”‚        â”‚çŠ¶æ€ç®¡ç†  â”‚       â”‚è´¨é‡æ§åˆ¶  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Function Calling å·¥ä½œæµ
1. **Coordinator** æ¥æ”¶ç”¨æˆ·è¾“å…¥ â†’ è§£ææ„å›¾ â†’ ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
2. **Executor** æ ¹æ®è®¡åˆ’ â†’ å¹¶è¡Œè°ƒç”¨åç«¯æœåŠ¡ Function
3. **Aggregator** æ”¶é›†ç»“æœ â†’ æ™ºèƒ½èšåˆ â†’ è¿”å›æœ€ç»ˆç­”æ¡ˆ

### æ ¸å¿ƒ Function å®šä¹‰
```python
# GIS åˆ†æå·¥å…·
gis_buffer_analysis()      # ç¼“å†²åŒºåˆ†æ
gis_distance_analysis()    # è·ç¦»åˆ†æ  
gis_accessibility_query()  # å¯è¾¾æ€§åˆ†æ
gis_spatial_query()        # ç©ºé—´æŸ¥è¯¢

# çŸ¥è¯†åº“å·¥å…·
knowledge_search()         # å‘é‡æ£€ç´¢
knowledge_document_qa()    # æ–‡æ¡£é—®ç­”
knowledge_summarize()      # çŸ¥è¯†æ€»ç»“

# SuperMap æœåŠ¡
supermap_layer_query()     # å›¾å±‚æŸ¥è¯¢
supermap_map_service()     # åœ°å›¾æœåŠ¡
supermap_data_analysis()   # æ•°æ®åˆ†æ
```

## ğŸ” RAG æ¶æ„ (æ£€ç´¢å¢å¼ºç”Ÿæˆ)

### RAG æµç¨‹è®¾è®¡
```
ç”¨æˆ·æŸ¥è¯¢ â†’ æ„å›¾ç†è§£ â†’ çŸ¥è¯†æ£€ç´¢ â†’ ä¸Šä¸‹æ–‡å¢å¼º â†’ æœåŠ¡è°ƒåº¦ â†’ ç»“æœç”Ÿæˆ
    â†“         â†“         â†“         â†“         â†“         â†“
Coordinator â†’ Vector DB â†’ Context â†’ Executor â†’ Backend â†’ Aggregator
```

### çŸ¥è¯†åº“ RAG å®ç°
- **æ–‡æ¡£åˆ‡ç‰‡**: 512 token chunks, 50 overlap
- **å‘é‡åŒ–**: OpenAI text-embedding-ada-002
- **æ£€ç´¢ç­–ç•¥**: ç›¸ä¼¼åº¦ + å…³é”®è¯æ··åˆæ£€ç´¢
- **é‡æ’åº**: Cross-encoder é‡æ’åº Top-K ç»“æœ

### æœåŠ¡è°ƒåº¦ RAG å¢å¼º
```python
# RAG å¢å¼ºçš„æœåŠ¡è°ƒåº¦æµç¨‹
class RAGEnhancedOrchestrator:
    async def process_query(self, user_query: str):
        # 1. æ£€ç´¢ç›¸å…³çŸ¥è¯†
        knowledge = await self.knowledge_retrieval(user_query)
        
        # 2. å¢å¼ºä¸Šä¸‹æ–‡
        enhanced_context = self.enhance_context(user_query, knowledge)
        
        # 3. æ™ºèƒ½æœåŠ¡è°ƒåº¦
        services = await self.schedule_services(enhanced_context)
        
        # 4. æ‰§è¡Œå¹¶èšåˆç»“æœ
        results = await self.execute_and_aggregate(services)
        return results
```

## ğŸ› ï¸ åç«¯æœåŠ¡å®šä¹‰

### GIS æœåŠ¡æ¨¡å— (app/infrastructure/database/postgres/)
- `BufferAnalysisService` - ç¼“å†²åŒºåˆ†æ
- `DistanceAnalysisService` - è·ç¦»è®¡ç®—  
- `AccessibilityService` - å¯è¾¾æ€§åˆ†æ
- `SpatialQueryService` - ç©ºé—´æŸ¥è¯¢
- `GeometryProcessService` - å‡ ä½•å¤„ç†

### çŸ¥è¯†åº“æœåŠ¡æ¨¡å— (app/infrastructure/vector/)
- `VectorSearchService` - å‘é‡æ£€ç´¢
- `DocumentService` - æ–‡æ¡£ç®¡ç†
- `EmbeddingService` - å‘é‡åŒ–æœåŠ¡
- `QAService` - é—®ç­”æœåŠ¡

### SuperMap é›†æˆæœåŠ¡ (app/infrastructure/external/supermap/)
- `LayerManagementService` - å›¾å±‚ç®¡ç†
- `MapService` - åœ°å›¾æœåŠ¡ä»£ç†
- `DataAnalysisService` - æ•°æ®åˆ†ææœåŠ¡

## ğŸ“¡ API æ¥å£è®¾è®¡

### æ ¸å¿ƒæ¥å£
- `POST /api/v1/agent/chat` - å¤šæ™ºèƒ½ä½“å¯¹è¯
- `POST /api/v1/gis/analysis` - GIS åˆ†ææœåŠ¡
- `POST /api/v1/knowledge/search` - çŸ¥è¯†æ£€ç´¢
- `GET /api/v1/health` - å¥åº·æ£€æŸ¥

### æ™ºèƒ½ä½“å¯¹è¯æ¥å£ç¤ºä¾‹
```json
{
  "message": "åˆ†æåŒ—äº¬å¸‚500ç±³å†…çš„åŒ»é™¢åˆ†å¸ƒ",
  "context": {
    "location": "åŒ—äº¬å¸‚",
    "analysis_type": "buffer_analysis",
    "radius": 500
  },
  "stream": true
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### æ™ºèƒ½ä½“å±‚ä¼˜åŒ–
- ä» 4 å±‚å‡å°‘åˆ° 3 å±‚ï¼Œé™ä½ 30% å»¶è¿Ÿ
- Executor æ”¯æŒå·¥å…·å¹¶è¡Œè°ƒç”¨
- æ™ºèƒ½ç¼“å­˜ä¸­é—´ç»“æœ

### æ•°æ®åº“ä¼˜åŒ–
- PostgreSQL è¿æ¥æ±  (10-20 è¿æ¥)
- Redis é›†ç¾¤æ¨¡å¼ï¼Œè¯»å†™åˆ†ç¦»
- å‘é‡æ•°æ®åº“ç´¢å¼•ä¼˜åŒ– (HNSW)

### API ä¼˜åŒ–
- å¼‚æ­¥å¤„ç†é•¿æ—¶é—´ä»»åŠ¡
- æµå¼å“åº”æ”¯æŒ
- è¯·æ±‚é™æµå’Œç¼“å­˜

## ğŸ”§ å¼€å‘è§„èŒƒ

### ä»£ç ç»„ç»‡
- éµå¾ª DDD é¢†åŸŸé©±åŠ¨è®¾è®¡
- ä½¿ç”¨ä¾èµ–æ³¨å…¥ (FastAPI Depends)
- æ¥å£ä¸å®ç°åˆ†ç¦»

### æ•°æ®åº“æ“ä½œ
- ä½¿ç”¨ SQLAlchemy 2.0 å¼‚æ­¥ORM
- äº‹åŠ¡ç®¡ç†å’Œè¿æ¥æ± 
- ç©ºé—´æ•°æ®ç”¨ GeoAlchemy2

### æµ‹è¯•ç­–ç•¥
- å•å…ƒæµ‹è¯•: æ¯ä¸ªé¢†åŸŸæœåŠ¡
- é›†æˆæµ‹è¯•: API ç«¯åˆ°ç«¯
- æ€§èƒ½æµ‹è¯•: æ™ºèƒ½ä½“å“åº”æ—¶é—´

## ğŸƒâ€â™‚ï¸ å¿«é€Ÿå¼€å§‹å‘½ä»¤

```bash
# å¯åŠ¨å¼€å‘ç¯å¢ƒ
docker-compose up -d postgres redis qdrant
python -m uvicorn app.main:app --reload --port 8000

# æ•°æ®åº“è¿ç§»
alembic upgrade head

# è¿è¡Œæµ‹è¯•
pytest app/tests/ -v

# æ„å»ºç”Ÿäº§é•œåƒ
docker build -t supermap-backend .
```

## ğŸ“ é‡è¦æé†’

### æ™ºèƒ½ä½“è°ƒç”¨æµç¨‹
1. æ‰€æœ‰ç”¨æˆ·è¯·æ±‚é€šè¿‡ `AgentHub` å¤„ç†
2. `Coordinator` è´Ÿè´£æ„å›¾ç†è§£å’Œä»»åŠ¡åˆ†è§£
3. `Executor` å¹¶è¡Œè°ƒç”¨å…·ä½“çš„åç«¯æœåŠ¡ Function
4. `Aggregator` èšåˆç»“æœå¹¶æ ¼å¼åŒ–è¿”å›

### æœåŠ¡æ‰©å±•è§„åˆ™
- æ–°å¢ GIS åŠŸèƒ½åœ¨ `app/domains/gis/` æ·»åŠ é¢†åŸŸæœåŠ¡
- æ–°å¢ API åœ¨ `app/api/v1/` å¯¹åº”æ¨¡å—æ·»åŠ è·¯ç”±
- Function Calling å·¥å…·åœ¨ `app/infrastructure/ai/tools/` å®šä¹‰

### ç›‘æ§è¦ç‚¹
- æ™ºèƒ½ä½“å“åº”æ—¶é—´ < 3ç§’
- æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡ < 80%
- Redis å†…å­˜ä½¿ç”¨ç‡ < 70%
- API é”™è¯¯ç‡ < 1%

## ğŸ—‚ï¸ å®Œæ•´ç›®å½•æ¶æ„ (å·²æ„å»º)

### å®é™…ç›®å½•ç»“æ„ (æ€»è®¡94ä¸ªæ–‡ä»¶)

Backend/
  â”œâ”€â”€ app/
  â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”œâ”€â”€ main.py                           # FastAPIåº”ç”¨å…¥å£
  â”‚   â”‚
  â”‚   â”œâ”€â”€ core/                             # æ ¸å¿ƒåŸºç¡€è®¾æ–½
  â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”œâ”€â”€ config.py                     # ç»Ÿä¸€é…ç½®ç®¡ç†
  â”‚   â”‚   â”œâ”€â”€ database.py                   # æ•°æ®åº“è¿æ¥æ± 
  â”‚   â”‚   â”œâ”€â”€ cache.py                      # Redisç¼“å­˜
  â”‚   â”‚   â”œâ”€â”€ security.py                   # å®‰å…¨ç›¸å…³
  â”‚   â”‚   â”œâ”€â”€ exceptions.py                 # å¼‚å¸¸å¤„ç†
  â”‚   â”‚   â”œâ”€â”€ logging.py                    # æ—¥å¿—é…ç½®
  â”‚   â”‚   â””â”€â”€ middleware.py                 # ä¸­é—´ä»¶
  â”‚   â”‚
  â”‚   â”œâ”€â”€ domains/                          # é¢†åŸŸå±‚(DDD)
  â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€â”€ agent/                        # æ™ºèƒ½ä½“åŸŸ
  â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ entities.py               # å®ä½“å®šä¹‰
  â”‚   â”‚   â”‚   â”œâ”€â”€ value_objects.py          # å€¼å¯¹è±¡
  â”‚   â”‚   â”‚   â”œâ”€â”€ repositories.py           # ä»“å‚¨æ¥å£
  â”‚   â”‚   â”‚   â”œâ”€â”€ services.py               # é¢†åŸŸæœåŠ¡
  â”‚   â”‚   â”‚   â””â”€â”€ events.py                 # é¢†åŸŸäº‹ä»¶
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€â”€ gis/                          # GISåŸŸ
  â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ entities.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ value_objects.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ repositories.py
  â”‚   â”‚   â”‚   â””â”€â”€ services.py
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€â”€ knowledge/                    # çŸ¥è¯†åº“åŸŸ
  â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ entities.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ value_objects.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ repositories.py
  â”‚   â”‚   â”‚   â””â”€â”€ services.py
  â”‚   â”‚   â”‚
  â”‚   â”‚   â””â”€â”€ user/                         # ç”¨æˆ·åŸŸ
  â”‚   â”‚       â”œâ”€â”€ __init__.py
  â”‚   â”‚       â”œâ”€â”€ entities.py
  â”‚   â”‚       â”œâ”€â”€ value_objects.py
  â”‚   â”‚       â”œâ”€â”€ repositories.py
  â”‚   â”‚       â””â”€â”€ services.py
  â”‚   â”‚
  â”‚   â”œâ”€â”€ application/                      # åº”ç”¨å±‚
  â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”œâ”€â”€ dto/                          # æ•°æ®ä¼ è¾“å¯¹è±¡
  â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ agent_dto.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ gis_dto.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ knowledge_dto.py
  â”‚   â”‚   â”‚   â””â”€â”€ user_dto.py
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€â”€ use_cases/                    # ç”¨ä¾‹å±‚
  â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ agent/
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ chat_use_case.py
  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ workflow_use_case.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ gis/
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ analysis_use_case.py
  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ query_use_case.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ knowledge/
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ search_use_case.py
  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ document_use_case.py
  â”‚   â”‚   â”‚   â””â”€â”€ user/
  â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚       â”œâ”€â”€ auth_use_case.py
  â”‚   â”‚   â”‚       â””â”€â”€ profile_use_case.py
  â”‚   â”‚   â”‚
  â”‚   â”‚   â””â”€â”€ handlers/                     # äº‹ä»¶å¤„ç†å™¨
  â”‚   â”‚       â”œâ”€â”€ __init__.py
  â”‚   â”‚       â”œâ”€â”€ agent_handlers.py
  â”‚   â”‚       â”œâ”€â”€ gis_handlers.py
  â”‚   â”‚       â””â”€â”€ notification_handlers.py
  â”‚   â”‚
  â”‚   â”œâ”€â”€ infrastructure/                   # åŸºç¡€è®¾æ–½å±‚
  â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€â”€ ai/                           # AIåŸºç¡€è®¾æ–½
  â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ agent_hub.py              # ä¼˜åŒ–åçš„æ™ºèƒ½ä½“ä¸­å¿ƒ
  â”‚   â”‚   â”‚   â”œâ”€â”€ coordinator.py            # åè°ƒæ™ºèƒ½ä½“
  â”‚   â”‚   â”‚   â”œâ”€â”€ executor.py               # æ‰§è¡Œæ™ºèƒ½ä½“  
  â”‚   â”‚   â”‚   â”œâ”€â”€ aggregator.py             # èšåˆæ™ºèƒ½ä½“
  â”‚   â”‚   â”‚   â”œâ”€â”€ tools/                    # å·¥å…·é›†
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ gis_tools.py
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ knowledge_tools.py
  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ analysis_tools.py
  â”‚   â”‚   â”‚   â””â”€â”€ prompts/                  # æç¤ºè¯åº“
  â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚       â”œâ”€â”€ coordinator_prompts.py
  â”‚   â”‚   â”‚       â”œâ”€â”€ executor_prompts.py
  â”‚   â”‚   â”‚       â””â”€â”€ aggregator_prompts.py
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€â”€ database/                     # æ•°æ®è®¿é—®å±‚
  â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ postgres/
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ connection.py
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ models.py
  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ repositories.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ redis/
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ connection.py
  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ cache_service.py
  â”‚   â”‚   â”‚   â””â”€â”€ vector/
  â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚       â”œâ”€â”€ qdrant_client.py
  â”‚   â”‚   â”‚       â””â”€â”€ vector_service.py
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€â”€ external/                     # å¤–éƒ¨æœåŠ¡é›†æˆ
  â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚   â”œâ”€â”€ supermap/
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ client.py
  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ layer_service.py
  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ map_service.py
  â”‚   â”‚   â”‚   â””â”€â”€ llm/
  â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”‚       â”œâ”€â”€ openai_client.py
  â”‚   â”‚   â”‚       â””â”€â”€ embedding_client.py
  â”‚   â”‚   â”‚
  â”‚   â”‚   â””â”€â”€ monitoring/                   # ç›‘æ§åŸºç¡€è®¾æ–½
  â”‚   â”‚       â”œâ”€â”€ __init__.py
  â”‚   â”‚       â”œâ”€â”€ metrics.py                # æŒ‡æ ‡æ”¶é›†
  â”‚   â”‚       â”œâ”€â”€ health_check.py           # å¥åº·æ£€æŸ¥
  â”‚   â”‚       â””â”€â”€ tracing.py                # åˆ†å¸ƒå¼è¿½è¸ª
  â”‚   â”‚
  â”‚   â”œâ”€â”€ api/                              # æ¥å£å±‚
  â”‚   â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚   â”œâ”€â”€ dependencies.py               # ä¾èµ–æ³¨å…¥
  â”‚   â”‚   â”œâ”€â”€ middleware.py                 # APIä¸­é—´ä»¶
  â”‚   â”‚   â”‚
  â”‚   â”‚   â””â”€â”€ v1/                           # APIç‰ˆæœ¬1
  â”‚   â”‚       â”œâ”€â”€ __init__.py
  â”‚   â”‚       â”œâ”€â”€ agent/
  â”‚   â”‚       â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚       â”‚   â”œâ”€â”€ chat.py
  â”‚   â”‚       â”‚   â””â”€â”€ workflow.py
  â”‚   â”‚       â”œâ”€â”€ gis/
  â”‚   â”‚       â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚       â”‚   â”œâ”€â”€ analysis.py
  â”‚   â”‚       â”‚   â””â”€â”€ query.py
  â”‚   â”‚       â”œâ”€â”€ knowledge/
  â”‚   â”‚       â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚       â”‚   â”œâ”€â”€ search.py
  â”‚   â”‚       â”‚   â””â”€â”€ documents.py
  â”‚   â”‚       â”œâ”€â”€ user/
  â”‚   â”‚       â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”‚       â”‚   â”œâ”€â”€ auth.py
  â”‚   â”‚       â”‚   â””â”€â”€ profile.py
  â”‚   â”‚       â””â”€â”€ health.py                 # å¥åº·æ£€æŸ¥æ¥å£
  â”‚   â”‚
  â”‚   â””â”€â”€ tests/                            # æµ‹è¯•
  â”‚       â”œâ”€â”€ __init__.py
  â”‚       â”œâ”€â”€ conftest.py
  â”‚       â”œâ”€â”€ unit/                         # å•å…ƒæµ‹è¯•
  â”‚       â”œâ”€â”€ integration/                  # é›†æˆæµ‹è¯•
  â”‚       â””â”€â”€ e2e/                          # ç«¯åˆ°ç«¯æµ‹è¯•
  â”‚
  â”œâ”€â”€ migrations/                           # æ•°æ®åº“è¿ç§»
  â”œâ”€â”€ docker/                               # å®¹å™¨é…ç½®
  â”œâ”€â”€ scripts/                              # è„šæœ¬å·¥å…·
  â”œâ”€â”€ requirements.txt
  â”œâ”€â”€ pyproject.toml                        # é¡¹ç›®é…ç½®
  â”œâ”€â”€ Dockerfile
  â”œâ”€â”€ docker-compose.yml
  â””â”€â”€ README.md

## ğŸ“‹ é¡¹ç›®å¼€å‘è·¯çº¿å›¾

### ğŸ”¥ Phase 1: ä¼ ç»Ÿæ¨¡å¼APIå®ç° (å½“å‰é˜¶æ®µ)
**ç›®æ ‡**: å®ç°å‰ç«¯ä¼ ç»Ÿæ¨¡å¼ä¸‹æ‰€æœ‰GISåŠŸèƒ½çš„åç«¯APIæ”¯æŒ

#### 1.1 ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- [ ] ç”¨æˆ·æ³¨å†Œ/ç™»å½•API (`app/api/v1/user/auth.py`)
- [ ] JWT token è®¤è¯æœºåˆ¶ (`app/core/security.py`)
- [ ] ç”¨æˆ·æƒé™ç®¡ç† (`app/domains/user/`)

#### 1.2 GISæ ¸å¿ƒåŠŸèƒ½API
- [ ] å›¾å±‚ç®¡ç†æ¥å£ (`app/api/v1/gis/query.py`)
  - å›¾å±‚åˆ—è¡¨æŸ¥è¯¢
  - å›¾å±‚æ˜¾ç¤º/éšè—æ§åˆ¶
  - å›¾å±‚å±æ€§æŸ¥è¯¢
- [ ] ç©ºé—´åˆ†ææ¥å£ (`app/api/v1/gis/analysis.py`)
  - ç¼“å†²åŒºåˆ†æ (BufferAnalysisPanel)
  - è·ç¦»åˆ†æ (DistanceAnalysisPanel) 
  - å¯è¾¾æ€§åˆ†æ (AccessibilityAnalysisPanel)
- [ ] è¦ç´ æŸ¥è¯¢æ¥å£
  - å±æ€§æŸ¥è¯¢
  - ç©ºé—´æŸ¥è¯¢
  - SQLæŸ¥è¯¢

#### 1.3 SuperMapæœåŠ¡ä»£ç†
- [ ] SuperMapå®¢æˆ·ç«¯å°è£… (`app/infrastructure/external/supermap/`)
- [ ] åœ°å›¾æœåŠ¡ä»£ç†
- [ ] æ•°æ®æœåŠ¡ä»£ç†
- [ ] å›¾å±‚æœåŠ¡ä»£ç†

### ğŸ—„ï¸ Phase 2: æ•°æ®åº“æ­å»ºä¸æ•°æ®è¿ç§»
**ç›®æ ‡**: å°†å‰ç«¯localStorageæ•°æ®è¿ç§»åˆ°åç«¯æ•°æ®åº“

#### 2.1 æ•°æ®åº“æ¶æ„è®¾è®¡
- [ ] PostgreSQL + PostGIS ç¯å¢ƒæ­å»º
- [ ] æ•°æ®æ¨¡å‹è®¾è®¡ (`app/infrastructure/database/postgres/models.py`)
  - ç”¨æˆ·è¡¨ (users)
  - GISæ•°æ®è¡¨ (gis_features)
  - ä¼šè¯è¡¨ (chat_sessions)
  - å›¾å±‚é…ç½®è¡¨ (layer_configs)

#### 2.2 æ•°æ®è¿ç§»ç­–ç•¥
- [ ] å‰ç«¯æ•°æ®å¯¼å‡ºAPI
- [ ] æ•°æ®æ ¼å¼è½¬æ¢å·¥å…·
- [ ] æ‰¹é‡æ•°æ®å¯¼å…¥è„šæœ¬
- [ ] æ•°æ®ä¸€è‡´æ€§éªŒè¯

#### 2.3 ç¼“å­˜å±‚å®ç°
- [ ] Redis é›†ç¾¤é…ç½®
- [ ] ç¼“å­˜ç­–ç•¥å®ç° (`app/core/cache.py`)
- [ ] ä¼šè¯ç®¡ç†
- [ ] æŸ¥è¯¢ç»“æœç¼“å­˜

### ğŸ¤– Phase 3: LangChainå¤šæ™ºèƒ½ä½“ç³»ç»Ÿ
**ç›®æ ‡**: é›†æˆLangChainæ¡†æ¶ï¼Œå®ç°çŸ¥è¯†åº“å’Œå¤šæ™ºèƒ½ä½“åŠŸèƒ½

#### 3.1 çŸ¥è¯†åº“æ„å»º
- [ ] å‘é‡æ•°æ®åº“æ­å»º (Qdrant)
- [ ] æ–‡æ¡£å¤„ç†ç®¡é“ (`app/infrastructure/database/vector/`)
- [ ] æ–‡æœ¬åˆ‡ç‰‡å’Œå‘é‡åŒ–
- [ ] æ£€ç´¢æœåŠ¡å®ç° (`app/domains/knowledge/`)

#### 3.2 å¤šæ™ºèƒ½ä½“æ¶æ„å®ç°
- [ ] Agent Hub ä¸­å¿ƒ (`app/infrastructure/ai/agent_hub.py`)
- [ ] Coordinator åè°ƒæ™ºèƒ½ä½“ (`app/infrastructure/ai/coordinator.py`)
- [ ] Executor æ‰§è¡Œæ™ºèƒ½ä½“ (`app/infrastructure/ai/executor.py`)
- [ ] Aggregator èšåˆæ™ºèƒ½ä½“ (`app/infrastructure/ai/aggregator.py`)

#### 3.3 Function Callingå·¥å…·é›†
- [ ] GISå·¥å…·é›† (`app/infrastructure/ai/tools/gis_tools.py`)
  - gis_buffer_analysis()
  - gis_distance_analysis()
  - gis_accessibility_query()
  - gis_spatial_query()
- [ ] çŸ¥è¯†åº“å·¥å…·é›† (`app/infrastructure/ai/tools/knowledge_tools.py`)
  - knowledge_search()
  - knowledge_document_qa()
  - knowledge_summarize()
- [ ] SuperMapå·¥å…·é›† (`app/infrastructure/ai/tools/analysis_tools.py`)
  - supermap_layer_query()
  - supermap_map_service()
  - supermap_data_analysis()

#### 3.4 RAGæ¶æ„å®ç°
- [ ] RAGæµç¨‹è®¾è®¡
- [ ] ä¸Šä¸‹æ–‡å¢å¼ºæœºåˆ¶
- [ ] æ™ºèƒ½æœåŠ¡è°ƒåº¦
- [ ] ç»“æœèšåˆä¼˜åŒ–

#### 3.5 å¯¹è¯ç³»ç»Ÿé›†æˆ
- [ ] æµå¼å¯¹è¯æ¥å£ (`app/api/v1/agent/chat.py`)
- [ ] ä¸Šä¸‹æ–‡ç®¡ç†
- [ ] å¤šè½®å¯¹è¯æ”¯æŒ
- [ ] WebSocketå®æ—¶é€šä¿¡

### ğŸ§ª Phase 4: æµ‹è¯•ä¸ä¼˜åŒ–
**ç›®æ ‡**: å…¨é¢æµ‹è¯•ç³»ç»ŸåŠŸèƒ½ï¼Œæ€§èƒ½ä¼˜åŒ–

#### 4.1 å•å…ƒæµ‹è¯•
- [ ] é¢†åŸŸæœåŠ¡æµ‹è¯• (`app/tests/unit/`)
- [ ] APIæ¥å£æµ‹è¯•
- [ ] æ•°æ®åº“æ“ä½œæµ‹è¯•
- [ ] æ™ºèƒ½ä½“åŠŸèƒ½æµ‹è¯•

#### 4.2 é›†æˆæµ‹è¯•
- [ ] ç«¯åˆ°ç«¯APIæµ‹è¯• (`app/tests/integration/`)
- [ ] å‰åç«¯é›†æˆæµ‹è¯•
- [ ] æ•°æ®åº“é›†æˆæµ‹è¯•
- [ ] å¤–éƒ¨æœåŠ¡é›†æˆæµ‹è¯•

#### 4.3 æ€§èƒ½æµ‹è¯•
- [ ] APIå“åº”æ—¶é—´æµ‹è¯•
- [ ] æ™ºèƒ½ä½“å¤„ç†æ€§èƒ½æµ‹è¯•
- [ ] æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½æµ‹è¯•
- [ ] å¹¶å‘è®¿é—®æµ‹è¯•

#### 4.4 éƒ¨ç½²ä¸ç›‘æ§
- [ ] Dockerå®¹å™¨åŒ–éƒ¨ç½²
- [ ] Kubernetesé›†ç¾¤éƒ¨ç½²
- [ ] ç›‘æ§ç³»ç»Ÿæ­å»º (`app/infrastructure/monitoring/`)
- [ ] æ—¥å¿—ç³»ç»Ÿå®Œå–„
- [ ] å¥åº·æ£€æŸ¥æœºåˆ¶

## ğŸ¯ å½“å‰å¼€å‘é‡ç‚¹

### ç«‹å³å¼€å§‹: Phase 1.1 - ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
1. **åˆ›å»ºç”¨æˆ·å®ä½“å’ŒDTO** (`app/domains/user/entities.py`)
2. **å®ç°JWTè®¤è¯** (`app/core/security.py`)
3. **ç”¨æˆ·æ³¨å†Œ/ç™»å½•API** (`app/api/v1/user/auth.py`)
4. **æƒé™ä¸­é—´ä»¶** (`app/api/middleware.py`)

### æ¥ä¸‹æ¥: Phase 1.2 - GISæ ¸å¿ƒåŠŸèƒ½
1. **å›¾å±‚ç®¡ç†APIå®ç°**
2. **ç©ºé—´åˆ†ææœåŠ¡å¼€å‘**
3. **SuperMapæœåŠ¡é›†æˆ**
4. **å‰ç«¯APIå¯¹æ¥æµ‹è¯•**

## ğŸƒâ€â™‚ï¸ å¿«é€Ÿå¼€å‘å‘½ä»¤

```bash
# 1. å¯åŠ¨å¼€å‘ç¯å¢ƒ
docker-compose up -d postgres redis

# 2. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 3. æ•°æ®åº“è¿ç§»
alembic upgrade head

# 4. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
uvicorn app.main:app --reload --port 8000

# 5. è¿è¡Œæµ‹è¯•
pytest app/tests/ -v
```

## ğŸ”¥ å¼€å‘ä¼˜å…ˆçº§æ’åº

### é«˜ä¼˜å…ˆçº§ (æœ¬å‘¨å®Œæˆ)
1. âœ… **ç›®å½•æ¶æ„æ­å»º** - å·²å®Œæˆ
2. ğŸ”¥ **ç”¨æˆ·è®¤è¯ç³»ç»Ÿ** - è¿›è¡Œä¸­
3. ğŸ”¥ **åŸºç¡€APIæ¡†æ¶** - å¾…å¼€å§‹

### ä¸­ä¼˜å…ˆçº§ (ä¸‹å‘¨å®Œæˆ)
1. **GISåŠŸèƒ½APIå®ç°**
2. **SuperMapæœåŠ¡é›†æˆ**
3. **æ•°æ®åº“æ¨¡å‹è®¾è®¡**

### ä½ä¼˜å…ˆçº§ (åç»­è¿­ä»£)
1. **LangChainé›†æˆ**
2. **å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ**
3. **æ€§èƒ½ä¼˜åŒ–**
